/* Copyright (c) 2020-2026 tevador <tevador@gmail.com> */
/* See LICENSE for licensing information */

#include <stdbool.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>

#include "program.h"
#include "platform.h"
#include "siphash_rng.h"

#define TRACE false
#define TRACE_PRINT(...) do { if (TRACE) printf(__VA_ARGS__); } while (false)

#define NUM_MUL_IMMS 4
#define NUM_SRC_PERM 625
#define NUM_MUL_OPCODES 4
#define NUM_ARX_OPCODES 8

/* Immediates for the MUL family of instructions */
static const uint8_t mul_imms[NUM_MUL_IMMS] = {
    1, 5, 17, 65
};

/* Lookup table for the ARX opcodes */
static const instr_type arx_lookup[NUM_ARX_OPCODES] = {
    INSTR_ARXSUB,
    INSTR_ARXADD,
    INSTR_ARXSUB,
    INSTR_ARXADD,
    INSTR_ARXROR,
    INSTR_ARXROR,
    INSTR_ARXASR,
    INSTR_ARXLSR
};

static const uint8_t src_lookup[NUM_SRC_PERM][8] = {
    { 0, 3, 1, 4, 5, 6, 7, 2 }, { 0, 3, 1, 4, 6, 7, 5, 2 },
    { 0, 3, 1, 4, 7, 6, 5, 2 }, { 0, 3, 4, 1, 5, 6, 7, 2 },
    { 0, 3, 4, 1, 6, 7, 5, 2 }, { 0, 3, 4, 1, 7, 6, 5, 2 },
    { 0, 3, 4, 5, 1, 6, 7, 2 }, { 0, 3, 4, 5, 6, 1, 7, 2 },
    { 0, 3, 4, 5, 6, 7, 1, 2 }, { 0, 3, 4, 5, 7, 6, 1, 2 },
    { 0, 3, 4, 6, 1, 7, 5, 2 }, { 0, 3, 4, 6, 5, 1, 7, 2 },
    { 0, 3, 4, 6, 5, 7, 1, 2 }, { 0, 3, 4, 6, 7, 1, 5, 2 },
    { 0, 3, 4, 7, 1, 6, 5, 2 }, { 0, 3, 4, 7, 5, 6, 1, 2 },
    { 0, 3, 4, 7, 6, 1, 5, 2 }, { 0, 3, 5, 4, 1, 6, 7, 2 },
    { 0, 3, 5, 4, 6, 1, 7, 2 }, { 0, 3, 5, 4, 6, 7, 1, 2 },
    { 0, 3, 5, 4, 7, 6, 1, 2 }, { 0, 3, 6, 4, 1, 7, 5, 2 },
    { 0, 3, 6, 4, 5, 1, 7, 2 }, { 0, 3, 6, 4, 5, 7, 1, 2 },
    { 0, 3, 6, 4, 7, 1, 5, 2 }, { 0, 3, 7, 4, 1, 6, 5, 2 },
    { 0, 3, 7, 4, 5, 6, 1, 2 }, { 0, 3, 7, 4, 6, 1, 5, 2 },
    { 0, 4, 1, 5, 3, 6, 7, 2 }, { 0, 4, 1, 5, 6, 3, 7, 2 },
    { 0, 4, 1, 5, 6, 7, 3, 2 }, { 0, 4, 1, 5, 7, 6, 3, 2 },
    { 0, 4, 1, 6, 3, 7, 5, 2 }, { 0, 4, 1, 6, 5, 3, 7, 2 },
    { 0, 4, 1, 6, 5, 7, 3, 2 }, { 0, 4, 1, 6, 7, 3, 5, 2 },
    { 0, 4, 1, 7, 3, 6, 5, 2 }, { 0, 4, 1, 7, 5, 6, 3, 2 },
    { 0, 4, 1, 7, 6, 3, 5, 2 }, { 0, 4, 3, 1, 5, 6, 7, 2 },
    { 0, 4, 3, 1, 6, 7, 5, 2 }, { 0, 4, 3, 1, 7, 6, 5, 2 },
    { 0, 4, 3, 5, 1, 6, 7, 2 }, { 0, 4, 3, 5, 6, 1, 7, 2 },
    { 0, 4, 3, 5, 6, 7, 1, 2 }, { 0, 4, 3, 5, 7, 6, 1, 2 },
    { 0, 4, 3, 6, 1, 7, 5, 2 }, { 0, 4, 3, 6, 5, 1, 7, 2 },
    { 0, 4, 3, 6, 5, 7, 1, 2 }, { 0, 4, 3, 6, 7, 1, 5, 2 },
    { 0, 4, 3, 7, 1, 6, 5, 2 }, { 0, 4, 3, 7, 5, 6, 1, 2 },
    { 0, 4, 3, 7, 6, 1, 5, 2 }, { 0, 4, 5, 1, 3, 6, 7, 2 },
    { 0, 4, 5, 1, 6, 3, 7, 2 }, { 0, 4, 5, 1, 6, 7, 3, 2 },
    { 0, 4, 5, 1, 7, 6, 3, 2 }, { 0, 4, 5, 6, 1, 3, 7, 2 },
    { 0, 4, 5, 6, 1, 7, 3, 2 }, { 0, 4, 5, 6, 3, 1, 7, 2 },
    { 0, 4, 5, 6, 3, 7, 1, 2 }, { 0, 4, 5, 6, 7, 1, 3, 2 },
    { 0, 4, 5, 6, 7, 3, 1, 2 }, { 0, 4, 5, 7, 1, 6, 3, 2 },
    { 0, 4, 5, 7, 3, 6, 1, 2 }, { 0, 4, 5, 7, 6, 1, 3, 2 },
    { 0, 4, 5, 7, 6, 3, 1, 2 }, { 0, 4, 6, 1, 3, 7, 5, 2 },
    { 0, 4, 6, 1, 5, 3, 7, 2 }, { 0, 4, 6, 1, 5, 7, 3, 2 },
    { 0, 4, 6, 1, 7, 3, 5, 2 }, { 0, 4, 6, 5, 1, 3, 7, 2 },
    { 0, 4, 6, 5, 1, 7, 3, 2 }, { 0, 4, 6, 5, 3, 1, 7, 2 },
    { 0, 4, 6, 5, 3, 7, 1, 2 }, { 0, 4, 6, 5, 7, 1, 3, 2 },
    { 0, 4, 6, 5, 7, 3, 1, 2 }, { 0, 4, 6, 7, 1, 3, 5, 2 },
    { 0, 4, 6, 7, 3, 1, 5, 2 }, { 0, 4, 6, 7, 5, 1, 3, 2 },
    { 0, 4, 6, 7, 5, 3, 1, 2 }, { 0, 4, 7, 1, 3, 6, 5, 2 },
    { 0, 4, 7, 1, 5, 6, 3, 2 }, { 0, 4, 7, 1, 6, 3, 5, 2 },
    { 0, 4, 7, 5, 1, 6, 3, 2 }, { 0, 4, 7, 5, 3, 6, 1, 2 },
    { 0, 4, 7, 5, 6, 1, 3, 2 }, { 0, 4, 7, 5, 6, 3, 1, 2 },
    { 0, 4, 7, 6, 1, 3, 5, 2 }, { 0, 4, 7, 6, 3, 1, 5, 2 },
    { 0, 4, 7, 6, 5, 1, 3, 2 }, { 0, 4, 7, 6, 5, 3, 1, 2 },
    { 0, 5, 1, 4, 3, 6, 7, 2 }, { 0, 5, 1, 4, 6, 3, 7, 2 },
    { 0, 5, 1, 4, 6, 7, 3, 2 }, { 0, 5, 1, 4, 7, 6, 3, 2 },
    { 0, 5, 3, 4, 1, 6, 7, 2 }, { 0, 5, 3, 4, 6, 1, 7, 2 },
    { 0, 5, 3, 4, 6, 7, 1, 2 }, { 0, 5, 3, 4, 7, 6, 1, 2 },
    { 0, 5, 4, 1, 3, 6, 7, 2 }, { 0, 5, 4, 1, 6, 3, 7, 2 },
    { 0, 5, 4, 1, 6, 7, 3, 2 }, { 0, 5, 4, 1, 7, 6, 3, 2 },
    { 0, 5, 4, 6, 1, 3, 7, 2 }, { 0, 5, 4, 6, 1, 7, 3, 2 },
    { 0, 5, 4, 6, 3, 1, 7, 2 }, { 0, 5, 4, 6, 3, 7, 1, 2 },
    { 0, 5, 4, 6, 7, 1, 3, 2 }, { 0, 5, 4, 6, 7, 3, 1, 2 },
    { 0, 5, 4, 7, 1, 6, 3, 2 }, { 0, 5, 4, 7, 3, 6, 1, 2 },
    { 0, 5, 4, 7, 6, 1, 3, 2 }, { 0, 5, 4, 7, 6, 3, 1, 2 },
    { 0, 5, 6, 4, 1, 3, 7, 2 }, { 0, 5, 6, 4, 1, 7, 3, 2 },
    { 0, 5, 6, 4, 3, 1, 7, 2 }, { 0, 5, 6, 4, 3, 7, 1, 2 },
    { 0, 5, 6, 4, 7, 1, 3, 2 }, { 0, 5, 6, 4, 7, 3, 1, 2 },
    { 0, 5, 7, 4, 1, 6, 3, 2 }, { 0, 5, 7, 4, 3, 6, 1, 2 },
    { 0, 5, 7, 4, 6, 1, 3, 2 }, { 0, 5, 7, 4, 6, 3, 1, 2 },
    { 0, 6, 1, 4, 3, 7, 5, 2 }, { 0, 6, 1, 4, 5, 3, 7, 2 },
    { 0, 6, 1, 4, 5, 7, 3, 2 }, { 0, 6, 1, 4, 7, 3, 5, 2 },
    { 0, 6, 3, 4, 1, 7, 5, 2 }, { 0, 6, 3, 4, 5, 1, 7, 2 },
    { 0, 6, 3, 4, 5, 7, 1, 2 }, { 0, 6, 3, 4, 7, 1, 5, 2 },
    { 0, 6, 4, 1, 3, 7, 5, 2 }, { 0, 6, 4, 1, 5, 3, 7, 2 },
    { 0, 6, 4, 1, 5, 7, 3, 2 }, { 0, 6, 4, 1, 7, 3, 5, 2 },
    { 0, 6, 4, 5, 1, 3, 7, 2 }, { 0, 6, 4, 5, 1, 7, 3, 2 },
    { 0, 6, 4, 5, 3, 1, 7, 2 }, { 0, 6, 4, 5, 3, 7, 1, 2 },
    { 0, 6, 4, 5, 7, 1, 3, 2 }, { 0, 6, 4, 5, 7, 3, 1, 2 },
    { 0, 6, 4, 7, 1, 3, 5, 2 }, { 0, 6, 4, 7, 3, 1, 5, 2 },
    { 0, 6, 4, 7, 5, 1, 3, 2 }, { 0, 6, 4, 7, 5, 3, 1, 2 },
    { 0, 6, 5, 4, 1, 3, 7, 2 }, { 0, 6, 5, 4, 1, 7, 3, 2 },
    { 0, 6, 5, 4, 3, 1, 7, 2 }, { 0, 6, 5, 4, 3, 7, 1, 2 },
    { 0, 6, 5, 4, 7, 1, 3, 2 }, { 0, 6, 5, 4, 7, 3, 1, 2 },
    { 0, 6, 7, 4, 1, 3, 5, 2 }, { 0, 6, 7, 4, 3, 1, 5, 2 },
    { 0, 6, 7, 4, 5, 1, 3, 2 }, { 0, 6, 7, 4, 5, 3, 1, 2 },
    { 0, 7, 1, 4, 3, 6, 5, 2 }, { 0, 7, 1, 4, 5, 6, 3, 2 },
    { 0, 7, 1, 4, 6, 3, 5, 2 }, { 0, 7, 3, 4, 1, 6, 5, 2 },
    { 0, 7, 3, 4, 5, 6, 1, 2 }, { 0, 7, 3, 4, 6, 1, 5, 2 },
    { 0, 7, 4, 1, 3, 6, 5, 2 }, { 0, 7, 4, 1, 5, 6, 3, 2 },
    { 0, 7, 4, 1, 6, 3, 5, 2 }, { 0, 7, 4, 5, 1, 6, 3, 2 },
    { 0, 7, 4, 5, 3, 6, 1, 2 }, { 0, 7, 4, 5, 6, 1, 3, 2 },
    { 0, 7, 4, 5, 6, 3, 1, 2 }, { 0, 7, 4, 6, 1, 3, 5, 2 },
    { 0, 7, 4, 6, 3, 1, 5, 2 }, { 0, 7, 4, 6, 5, 1, 3, 2 },
    { 0, 7, 4, 6, 5, 3, 1, 2 }, { 0, 7, 5, 4, 1, 6, 3, 2 },
    { 0, 7, 5, 4, 3, 6, 1, 2 }, { 0, 7, 5, 4, 6, 1, 3, 2 },
    { 0, 7, 5, 4, 6, 3, 1, 2 }, { 0, 7, 6, 4, 1, 3, 5, 2 },
    { 0, 7, 6, 4, 3, 1, 5, 2 }, { 0, 7, 6, 4, 5, 1, 3, 2 },
    { 0, 7, 6, 4, 5, 3, 1, 2 }, { 2, 3, 1, 4, 5, 6, 7, 0 },
    { 2, 3, 1, 4, 6, 7, 5, 0 }, { 2, 3, 1, 4, 7, 6, 5, 0 },
    { 2, 3, 4, 1, 5, 6, 7, 0 }, { 2, 3, 4, 1, 6, 7, 5, 0 },
    { 2, 3, 4, 1, 7, 6, 5, 0 }, { 2, 3, 4, 5, 1, 6, 7, 0 },
    { 2, 3, 4, 5, 6, 1, 7, 0 }, { 2, 3, 4, 5, 6, 7, 1, 0 },
    { 2, 3, 4, 5, 7, 6, 1, 0 }, { 2, 3, 4, 6, 1, 7, 5, 0 },
    { 2, 3, 4, 6, 5, 1, 7, 0 }, { 2, 3, 4, 6, 5, 7, 1, 0 },
    { 2, 3, 4, 6, 7, 1, 5, 0 }, { 2, 3, 4, 7, 1, 6, 5, 0 },
    { 2, 3, 4, 7, 5, 6, 1, 0 }, { 2, 3, 4, 7, 6, 1, 5, 0 },
    { 2, 3, 5, 4, 1, 6, 7, 0 }, { 2, 3, 5, 4, 6, 1, 7, 0 },
    { 2, 3, 5, 4, 6, 7, 1, 0 }, { 2, 3, 5, 4, 7, 6, 1, 0 },
    { 2, 3, 6, 4, 1, 7, 5, 0 }, { 2, 3, 6, 4, 5, 1, 7, 0 },
    { 2, 3, 6, 4, 5, 7, 1, 0 }, { 2, 3, 6, 4, 7, 1, 5, 0 },
    { 2, 3, 7, 4, 1, 6, 5, 0 }, { 2, 3, 7, 4, 5, 6, 1, 0 },
    { 2, 3, 7, 4, 6, 1, 5, 0 }, { 2, 4, 1, 5, 3, 6, 7, 0 },
    { 2, 4, 1, 5, 6, 3, 7, 0 }, { 2, 4, 1, 5, 6, 7, 3, 0 },
    { 2, 4, 1, 5, 7, 6, 3, 0 }, { 2, 4, 1, 6, 3, 7, 5, 0 },
    { 2, 4, 1, 6, 5, 3, 7, 0 }, { 2, 4, 1, 6, 5, 7, 3, 0 },
    { 2, 4, 1, 6, 7, 3, 5, 0 }, { 2, 4, 1, 7, 3, 6, 5, 0 },
    { 2, 4, 1, 7, 5, 6, 3, 0 }, { 2, 4, 1, 7, 6, 3, 5, 0 },
    { 2, 4, 3, 1, 5, 6, 7, 0 }, { 2, 4, 3, 1, 6, 7, 5, 0 },
    { 2, 4, 3, 1, 7, 6, 5, 0 }, { 2, 4, 3, 5, 1, 6, 7, 0 },
    { 2, 4, 3, 5, 6, 1, 7, 0 }, { 2, 4, 3, 5, 6, 7, 1, 0 },
    { 2, 4, 3, 5, 7, 6, 1, 0 }, { 2, 4, 3, 6, 1, 7, 5, 0 },
    { 2, 4, 3, 6, 5, 1, 7, 0 }, { 2, 4, 3, 6, 5, 7, 1, 0 },
    { 2, 4, 3, 6, 7, 1, 5, 0 }, { 2, 4, 3, 7, 1, 6, 5, 0 },
    { 2, 4, 3, 7, 5, 6, 1, 0 }, { 2, 4, 3, 7, 6, 1, 5, 0 },
    { 2, 4, 5, 1, 3, 6, 7, 0 }, { 2, 4, 5, 1, 6, 3, 7, 0 },
    { 2, 4, 5, 1, 6, 7, 3, 0 }, { 2, 4, 5, 1, 7, 6, 3, 0 },
    { 2, 4, 5, 6, 1, 3, 7, 0 }, { 2, 4, 5, 6, 1, 7, 3, 0 },
    { 2, 4, 5, 6, 3, 1, 7, 0 }, { 2, 4, 5, 6, 3, 7, 1, 0 },
    { 2, 4, 5, 6, 7, 1, 3, 0 }, { 2, 4, 5, 6, 7, 3, 1, 0 },
    { 2, 4, 5, 7, 1, 6, 3, 0 }, { 2, 4, 5, 7, 3, 6, 1, 0 },
    { 2, 4, 5, 7, 6, 1, 3, 0 }, { 2, 4, 5, 7, 6, 3, 1, 0 },
    { 2, 4, 6, 1, 3, 7, 5, 0 }, { 2, 4, 6, 1, 5, 3, 7, 0 },
    { 2, 4, 6, 1, 5, 7, 3, 0 }, { 2, 4, 6, 1, 7, 3, 5, 0 },
    { 2, 4, 6, 5, 1, 3, 7, 0 }, { 2, 4, 6, 5, 1, 7, 3, 0 },
    { 2, 4, 6, 5, 3, 1, 7, 0 }, { 2, 4, 6, 5, 3, 7, 1, 0 },
    { 2, 4, 6, 5, 7, 1, 3, 0 }, { 2, 4, 6, 5, 7, 3, 1, 0 },
    { 2, 4, 6, 7, 1, 3, 5, 0 }, { 2, 4, 6, 7, 3, 1, 5, 0 },
    { 2, 4, 6, 7, 5, 1, 3, 0 }, { 2, 4, 6, 7, 5, 3, 1, 0 },
    { 2, 4, 7, 1, 3, 6, 5, 0 }, { 2, 4, 7, 1, 5, 6, 3, 0 },
    { 2, 4, 7, 1, 6, 3, 5, 0 }, { 2, 4, 7, 5, 1, 6, 3, 0 },
    { 2, 4, 7, 5, 3, 6, 1, 0 }, { 2, 4, 7, 5, 6, 1, 3, 0 },
    { 2, 4, 7, 5, 6, 3, 1, 0 }, { 2, 4, 7, 6, 1, 3, 5, 0 },
    { 2, 4, 7, 6, 3, 1, 5, 0 }, { 2, 4, 7, 6, 5, 1, 3, 0 },
    { 2, 4, 7, 6, 5, 3, 1, 0 }, { 2, 5, 1, 4, 3, 6, 7, 0 },
    { 2, 5, 1, 4, 6, 3, 7, 0 }, { 2, 5, 1, 4, 6, 7, 3, 0 },
    { 2, 5, 1, 4, 7, 6, 3, 0 }, { 2, 5, 3, 4, 1, 6, 7, 0 },
    { 2, 5, 3, 4, 6, 1, 7, 0 }, { 2, 5, 3, 4, 6, 7, 1, 0 },
    { 2, 5, 3, 4, 7, 6, 1, 0 }, { 2, 5, 4, 1, 3, 6, 7, 0 },
    { 2, 5, 4, 1, 6, 3, 7, 0 }, { 2, 5, 4, 1, 6, 7, 3, 0 },
    { 2, 5, 4, 1, 7, 6, 3, 0 }, { 2, 5, 4, 6, 1, 3, 7, 0 },
    { 2, 5, 4, 6, 1, 7, 3, 0 }, { 2, 5, 4, 6, 3, 1, 7, 0 },
    { 2, 5, 4, 6, 3, 7, 1, 0 }, { 2, 5, 4, 6, 7, 1, 3, 0 },
    { 2, 5, 4, 6, 7, 3, 1, 0 }, { 2, 5, 4, 7, 1, 6, 3, 0 },
    { 2, 5, 4, 7, 3, 6, 1, 0 }, { 2, 5, 4, 7, 6, 1, 3, 0 },
    { 2, 5, 4, 7, 6, 3, 1, 0 }, { 2, 5, 6, 4, 1, 3, 7, 0 },
    { 2, 5, 6, 4, 1, 7, 3, 0 }, { 2, 5, 6, 4, 3, 1, 7, 0 },
    { 2, 5, 6, 4, 3, 7, 1, 0 }, { 2, 5, 6, 4, 7, 1, 3, 0 },
    { 2, 5, 6, 4, 7, 3, 1, 0 }, { 2, 5, 7, 4, 1, 6, 3, 0 },
    { 2, 5, 7, 4, 3, 6, 1, 0 }, { 2, 5, 7, 4, 6, 1, 3, 0 },
    { 2, 5, 7, 4, 6, 3, 1, 0 }, { 2, 6, 1, 4, 3, 7, 5, 0 },
    { 2, 6, 1, 4, 5, 3, 7, 0 }, { 2, 6, 1, 4, 5, 7, 3, 0 },
    { 2, 6, 1, 4, 7, 3, 5, 0 }, { 2, 6, 3, 4, 1, 7, 5, 0 },
    { 2, 6, 3, 4, 5, 1, 7, 0 }, { 2, 6, 3, 4, 5, 7, 1, 0 },
    { 2, 6, 3, 4, 7, 1, 5, 0 }, { 2, 6, 4, 1, 3, 7, 5, 0 },
    { 2, 6, 4, 1, 5, 3, 7, 0 }, { 2, 6, 4, 1, 5, 7, 3, 0 },
    { 2, 6, 4, 1, 7, 3, 5, 0 }, { 2, 6, 4, 5, 1, 3, 7, 0 },
    { 2, 6, 4, 5, 1, 7, 3, 0 }, { 2, 6, 4, 5, 3, 1, 7, 0 },
    { 2, 6, 4, 5, 3, 7, 1, 0 }, { 2, 6, 4, 5, 7, 1, 3, 0 },
    { 2, 6, 4, 5, 7, 3, 1, 0 }, { 2, 6, 4, 7, 1, 3, 5, 0 },
    { 2, 6, 4, 7, 3, 1, 5, 0 }, { 2, 6, 4, 7, 5, 1, 3, 0 },
    { 2, 6, 4, 7, 5, 3, 1, 0 }, { 2, 6, 5, 4, 1, 3, 7, 0 },
    { 2, 6, 5, 4, 1, 7, 3, 0 }, { 2, 6, 5, 4, 3, 1, 7, 0 },
    { 2, 6, 5, 4, 3, 7, 1, 0 }, { 2, 6, 5, 4, 7, 1, 3, 0 },
    { 2, 6, 5, 4, 7, 3, 1, 0 }, { 2, 6, 7, 4, 1, 3, 5, 0 },
    { 2, 6, 7, 4, 3, 1, 5, 0 }, { 2, 6, 7, 4, 5, 1, 3, 0 },
    { 2, 6, 7, 4, 5, 3, 1, 0 }, { 2, 7, 1, 4, 3, 6, 5, 0 },
    { 2, 7, 1, 4, 5, 6, 3, 0 }, { 2, 7, 1, 4, 6, 3, 5, 0 },
    { 2, 7, 3, 4, 1, 6, 5, 0 }, { 2, 7, 3, 4, 5, 6, 1, 0 },
    { 2, 7, 3, 4, 6, 1, 5, 0 }, { 2, 7, 4, 1, 3, 6, 5, 0 },
    { 2, 7, 4, 1, 5, 6, 3, 0 }, { 2, 7, 4, 1, 6, 3, 5, 0 },
    { 2, 7, 4, 5, 1, 6, 3, 0 }, { 2, 7, 4, 5, 3, 6, 1, 0 },
    { 2, 7, 4, 5, 6, 1, 3, 0 }, { 2, 7, 4, 5, 6, 3, 1, 0 },
    { 2, 7, 4, 6, 1, 3, 5, 0 }, { 2, 7, 4, 6, 3, 1, 5, 0 },
    { 2, 7, 4, 6, 5, 1, 3, 0 }, { 2, 7, 4, 6, 5, 3, 1, 0 },
    { 2, 7, 5, 4, 1, 6, 3, 0 }, { 2, 7, 5, 4, 3, 6, 1, 0 },
    { 2, 7, 5, 4, 6, 1, 3, 0 }, { 2, 7, 5, 4, 6, 3, 1, 0 },
    { 2, 7, 6, 4, 1, 3, 5, 0 }, { 2, 7, 6, 4, 3, 1, 5, 0 },
    { 2, 7, 6, 4, 5, 1, 3, 0 }, { 2, 7, 6, 4, 5, 3, 1, 0 },
    { 4, 2, 1, 5, 3, 6, 7, 0 }, { 4, 2, 1, 5, 6, 3, 7, 0 },
    { 4, 2, 1, 5, 6, 7, 3, 0 }, { 4, 2, 1, 5, 7, 6, 3, 0 },
    { 4, 2, 1, 6, 3, 7, 5, 0 }, { 4, 2, 1, 6, 5, 3, 7, 0 },
    { 4, 2, 1, 6, 5, 7, 3, 0 }, { 4, 2, 1, 6, 7, 3, 5, 0 },
    { 4, 2, 1, 7, 3, 6, 5, 0 }, { 4, 2, 1, 7, 5, 6, 3, 0 },
    { 4, 2, 1, 7, 6, 3, 5, 0 }, { 4, 2, 3, 1, 5, 6, 7, 0 },
    { 4, 2, 3, 1, 6, 7, 5, 0 }, { 4, 2, 3, 1, 7, 6, 5, 0 },
    { 4, 2, 3, 5, 1, 6, 7, 0 }, { 4, 2, 3, 5, 6, 1, 7, 0 },
    { 4, 2, 3, 5, 6, 7, 1, 0 }, { 4, 2, 3, 5, 7, 6, 1, 0 },
    { 4, 2, 3, 6, 1, 7, 5, 0 }, { 4, 2, 3, 6, 5, 1, 7, 0 },
    { 4, 2, 3, 6, 5, 7, 1, 0 }, { 4, 2, 3, 6, 7, 1, 5, 0 },
    { 4, 2, 3, 7, 1, 6, 5, 0 }, { 4, 2, 3, 7, 5, 6, 1, 0 },
    { 4, 2, 3, 7, 6, 1, 5, 0 }, { 4, 2, 5, 1, 3, 6, 7, 0 },
    { 4, 2, 5, 1, 6, 3, 7, 0 }, { 4, 2, 5, 1, 6, 7, 3, 0 },
    { 4, 2, 5, 1, 7, 6, 3, 0 }, { 4, 2, 5, 6, 1, 3, 7, 0 },
    { 4, 2, 5, 6, 1, 7, 3, 0 }, { 4, 2, 5, 6, 3, 1, 7, 0 },
    { 4, 2, 5, 6, 3, 7, 1, 0 }, { 4, 2, 5, 6, 7, 1, 3, 0 },
    { 4, 2, 5, 6, 7, 3, 1, 0 }, { 4, 2, 5, 7, 1, 6, 3, 0 },
    { 4, 2, 5, 7, 3, 6, 1, 0 }, { 4, 2, 5, 7, 6, 1, 3, 0 },
    { 4, 2, 5, 7, 6, 3, 1, 0 }, { 4, 2, 6, 1, 3, 7, 5, 0 },
    { 4, 2, 6, 1, 5, 3, 7, 0 }, { 4, 2, 6, 1, 5, 7, 3, 0 },
    { 4, 2, 6, 1, 7, 3, 5, 0 }, { 4, 2, 6, 5, 1, 3, 7, 0 },
    { 4, 2, 6, 5, 1, 7, 3, 0 }, { 4, 2, 6, 5, 3, 1, 7, 0 },
    { 4, 2, 6, 5, 3, 7, 1, 0 }, { 4, 2, 6, 5, 7, 1, 3, 0 },
    { 4, 2, 6, 5, 7, 3, 1, 0 }, { 4, 2, 6, 7, 1, 3, 5, 0 },
    { 4, 2, 6, 7, 3, 1, 5, 0 }, { 4, 2, 6, 7, 5, 1, 3, 0 },
    { 4, 2, 6, 7, 5, 3, 1, 0 }, { 4, 2, 7, 1, 3, 6, 5, 0 },
    { 4, 2, 7, 1, 5, 6, 3, 0 }, { 4, 2, 7, 1, 6, 3, 5, 0 },
    { 4, 2, 7, 5, 1, 6, 3, 0 }, { 4, 2, 7, 5, 3, 6, 1, 0 },
    { 4, 2, 7, 5, 6, 1, 3, 0 }, { 4, 2, 7, 5, 6, 3, 1, 0 },
    { 4, 2, 7, 6, 1, 3, 5, 0 }, { 4, 2, 7, 6, 3, 1, 5, 0 },
    { 4, 2, 7, 6, 5, 1, 3, 0 }, { 4, 2, 7, 6, 5, 3, 1, 0 },
    { 4, 3, 1, 5, 6, 7, 0, 2 }, { 4, 3, 1, 5, 7, 6, 0, 2 },
    { 4, 3, 1, 6, 5, 7, 0, 2 }, { 4, 3, 1, 7, 5, 6, 0, 2 },
    { 4, 3, 5, 1, 6, 7, 0, 2 }, { 4, 3, 5, 1, 7, 6, 0, 2 },
    { 4, 3, 5, 6, 1, 7, 0, 2 }, { 4, 3, 5, 6, 7, 1, 0, 2 },
    { 4, 3, 5, 7, 1, 6, 0, 2 }, { 4, 3, 5, 7, 6, 1, 0, 2 },
    { 4, 3, 6, 1, 5, 7, 0, 2 }, { 4, 3, 6, 5, 1, 7, 0, 2 },
    { 4, 3, 6, 5, 7, 1, 0, 2 }, { 4, 3, 6, 7, 5, 1, 0, 2 },
    { 4, 3, 7, 1, 5, 6, 0, 2 }, { 4, 3, 7, 5, 1, 6, 0, 2 },
    { 4, 3, 7, 5, 6, 1, 0, 2 }, { 4, 3, 7, 6, 5, 1, 0, 2 },
    { 4, 5, 1, 6, 3, 7, 0, 2 }, { 4, 5, 1, 6, 7, 3, 0, 2 },
    { 4, 5, 1, 7, 3, 6, 0, 2 }, { 4, 5, 1, 7, 6, 3, 0, 2 },
    { 4, 5, 3, 1, 6, 7, 0, 2 }, { 4, 5, 3, 1, 7, 6, 0, 2 },
    { 4, 5, 3, 6, 1, 7, 0, 2 }, { 4, 5, 3, 6, 7, 1, 0, 2 },
    { 4, 5, 3, 7, 1, 6, 0, 2 }, { 4, 5, 3, 7, 6, 1, 0, 2 },
    { 4, 5, 6, 1, 3, 7, 0, 2 }, { 4, 5, 6, 1, 7, 3, 0, 2 },
    { 4, 5, 6, 7, 1, 3, 0, 2 }, { 4, 5, 6, 7, 3, 1, 0, 2 },
    { 4, 5, 7, 1, 3, 6, 0, 2 }, { 4, 5, 7, 1, 6, 3, 0, 2 },
    { 4, 5, 7, 6, 1, 3, 0, 2 }, { 4, 5, 7, 6, 3, 1, 0, 2 },
    { 4, 6, 1, 5, 3, 7, 0, 2 }, { 4, 6, 1, 5, 7, 3, 0, 2 },
    { 4, 6, 1, 7, 5, 3, 0, 2 }, { 4, 6, 3, 1, 5, 7, 0, 2 },
    { 4, 6, 3, 5, 1, 7, 0, 2 }, { 4, 6, 3, 5, 7, 1, 0, 2 },
    { 4, 6, 3, 7, 5, 1, 0, 2 }, { 4, 6, 5, 1, 3, 7, 0, 2 },
    { 4, 6, 5, 1, 7, 3, 0, 2 }, { 4, 6, 5, 7, 1, 3, 0, 2 },
    { 4, 6, 5, 7, 3, 1, 0, 2 }, { 4, 6, 7, 1, 5, 3, 0, 2 },
    { 4, 6, 7, 5, 1, 3, 0, 2 }, { 4, 6, 7, 5, 3, 1, 0, 2 },
    { 4, 7, 1, 5, 3, 6, 0, 2 }, { 4, 7, 1, 5, 6, 3, 0, 2 },
    { 4, 7, 1, 6, 5, 3, 0, 2 }, { 4, 7, 3, 1, 5, 6, 0, 2 },
    { 4, 7, 3, 5, 1, 6, 0, 2 }, { 4, 7, 3, 5, 6, 1, 0, 2 },
    { 4, 7, 3, 6, 5, 1, 0, 2 }, { 4, 7, 5, 1, 3, 6, 0, 2 },
    { 4, 7, 5, 1, 6, 3, 0, 2 }, { 4, 7, 5, 6, 1, 3, 0, 2 },
    { 4, 7, 5, 6, 3, 1, 0, 2 }, { 4, 7, 6, 1, 5, 3, 0, 2 },
    { 4, 7, 6, 5, 1, 3, 0, 2 }, { 4, 7, 6, 5, 3, 1, 0, 2 },
    { 6, 2, 1, 4, 3, 7, 5, 0 }, { 6, 2, 1, 4, 5, 3, 7, 0 },
    { 6, 2, 1, 4, 5, 7, 3, 0 }, { 6, 2, 1, 4, 7, 3, 5, 0 },
    { 6, 2, 3, 4, 1, 7, 5, 0 }, { 6, 2, 3, 4, 5, 1, 7, 0 },
    { 6, 2, 3, 4, 5, 7, 1, 0 }, { 6, 2, 3, 4, 7, 1, 5, 0 },
    { 6, 2, 4, 1, 3, 7, 5, 0 }, { 6, 2, 4, 1, 5, 3, 7, 0 },
    { 6, 2, 4, 1, 5, 7, 3, 0 }, { 6, 2, 4, 1, 7, 3, 5, 0 },
    { 6, 2, 4, 5, 1, 3, 7, 0 }, { 6, 2, 4, 5, 1, 7, 3, 0 },
    { 6, 2, 4, 5, 3, 1, 7, 0 }, { 6, 2, 4, 5, 3, 7, 1, 0 },
    { 6, 2, 4, 5, 7, 1, 3, 0 }, { 6, 2, 4, 5, 7, 3, 1, 0 },
    { 6, 2, 4, 7, 1, 3, 5, 0 }, { 6, 2, 4, 7, 3, 1, 5, 0 },
    { 6, 2, 4, 7, 5, 1, 3, 0 }, { 6, 2, 4, 7, 5, 3, 1, 0 },
    { 6, 2, 5, 4, 1, 3, 7, 0 }, { 6, 2, 5, 4, 1, 7, 3, 0 },
    { 6, 2, 5, 4, 3, 1, 7, 0 }, { 6, 2, 5, 4, 3, 7, 1, 0 },
    { 6, 2, 5, 4, 7, 1, 3, 0 }, { 6, 2, 5, 4, 7, 3, 1, 0 },
    { 6, 2, 7, 4, 1, 3, 5, 0 }, { 6, 2, 7, 4, 3, 1, 5, 0 },
    { 6, 2, 7, 4, 5, 1, 3, 0 }, { 6, 2, 7, 4, 5, 3, 1, 0 },
    { 6, 3, 1, 4, 5, 7, 0, 2 }, { 6, 3, 4, 1, 5, 7, 0, 2 },
    { 6, 3, 4, 5, 1, 7, 0, 2 }, { 6, 3, 4, 5, 7, 1, 0, 2 },
    { 6, 3, 4, 7, 5, 1, 0, 2 }, { 6, 3, 5, 4, 1, 7, 0, 2 },
    { 6, 3, 5, 4, 7, 1, 0, 2 }, { 6, 3, 7, 4, 5, 1, 0, 2 },
    { 6, 4, 1, 5, 3, 7, 0, 2 }, { 6, 4, 1, 5, 7, 3, 0, 2 },
    { 6, 4, 1, 7, 5, 3, 0, 2 }, { 6, 4, 3, 1, 5, 7, 0, 2 },
    { 6, 4, 3, 5, 1, 7, 0, 2 }, { 6, 4, 3, 5, 7, 1, 0, 2 },
    { 6, 4, 3, 7, 5, 1, 0, 2 }, { 6, 4, 5, 1, 3, 7, 0, 2 },
    { 6, 4, 5, 1, 7, 3, 0, 2 }, { 6, 4, 5, 7, 1, 3, 0, 2 },
    { 6, 4, 5, 7, 3, 1, 0, 2 }, { 6, 4, 7, 1, 5, 3, 0, 2 },
    { 6, 4, 7, 5, 1, 3, 0, 2 }, { 6, 4, 7, 5, 3, 1, 0, 2 },
    { 6, 5, 1, 4, 3, 7, 0, 2 }, { 6, 5, 1, 4, 7, 3, 0, 2 },
    { 6, 5, 3, 4, 1, 7, 0, 2 }, { 6, 5, 3, 4, 7, 1, 0, 2 },
    { 6, 5, 4, 1, 3, 7, 0, 2 }, { 6, 5, 4, 1, 7, 3, 0, 2 },
    { 6, 5, 4, 7, 1, 3, 0, 2 }, { 6, 5, 4, 7, 3, 1, 0, 2 },
    { 6, 5, 7, 4, 1, 3, 0, 2 }, { 6, 5, 7, 4, 3, 1, 0, 2 },
    { 6, 7, 1, 4, 5, 3, 0, 2 }, { 6, 7, 3, 4, 5, 1, 0, 2 },
    { 6, 7, 4, 1, 5, 3, 0, 2 }, { 6, 7, 4, 5, 1, 3, 0, 2 },
    { 6, 7, 4, 5, 3, 1, 0, 2 }, { 6, 7, 5, 4, 1, 3, 0, 2 },
    { 6, 7, 5, 4, 3, 1, 0, 2 }, { 7, 2, 1, 4, 3, 6, 5, 0 },
    { 7, 2, 1, 4, 5, 6, 3, 0 }, { 7, 2, 1, 4, 6, 3, 5, 0 },
    { 7, 2, 3, 4, 1, 6, 5, 0 }, { 7, 2, 3, 4, 5, 6, 1, 0 },
    { 7, 2, 3, 4, 6, 1, 5, 0 }, { 7, 2, 4, 1, 3, 6, 5, 0 },
    { 7, 2, 4, 1, 5, 6, 3, 0 }, { 7, 2, 4, 1, 6, 3, 5, 0 },
    { 7, 2, 4, 5, 1, 6, 3, 0 }, { 7, 2, 4, 5, 3, 6, 1, 0 },
    { 7, 2, 4, 5, 6, 1, 3, 0 }, { 7, 2, 4, 5, 6, 3, 1, 0 },
    { 7, 2, 4, 6, 1, 3, 5, 0 }, { 7, 2, 4, 6, 3, 1, 5, 0 },
    { 7, 2, 4, 6, 5, 1, 3, 0 }, { 7, 2, 4, 6, 5, 3, 1, 0 },
    { 7, 2, 5, 4, 1, 6, 3, 0 }, { 7, 2, 5, 4, 3, 6, 1, 0 },
    { 7, 2, 5, 4, 6, 1, 3, 0 }, { 7, 2, 5, 4, 6, 3, 1, 0 },
    { 7, 2, 6, 4, 1, 3, 5, 0 }, { 7, 2, 6, 4, 3, 1, 5, 0 },
    { 7, 2, 6, 4, 5, 1, 3, 0 }, { 7, 2, 6, 4, 5, 3, 1, 0 },
    { 7, 3, 1, 4, 5, 6, 0, 2 }, { 7, 3, 4, 1, 5, 6, 0, 2 },
    { 7, 3, 4, 5, 1, 6, 0, 2 }, { 7, 3, 4, 5, 6, 1, 0, 2 },
    { 7, 3, 4, 6, 5, 1, 0, 2 }, { 7, 3, 5, 4, 1, 6, 0, 2 },
    { 7, 3, 5, 4, 6, 1, 0, 2 }, { 7, 3, 6, 4, 5, 1, 0, 2 },
    { 7, 4, 1, 5, 3, 6, 0, 2 }, { 7, 4, 1, 5, 6, 3, 0, 2 },
    { 7, 4, 1, 6, 5, 3, 0, 2 }, { 7, 4, 3, 1, 5, 6, 0, 2 },
    { 7, 4, 3, 5, 1, 6, 0, 2 }, { 7, 4, 3, 5, 6, 1, 0, 2 },
    { 7, 4, 3, 6, 5, 1, 0, 2 }, { 7, 4, 5, 1, 3, 6, 0, 2 },
    { 7, 4, 5, 1, 6, 3, 0, 2 }, { 7, 4, 5, 6, 1, 3, 0, 2 },
    { 7, 4, 5, 6, 3, 1, 0, 2 }, { 7, 4, 6, 1, 5, 3, 0, 2 },
    { 7, 4, 6, 5, 1, 3, 0, 2 }, { 7, 4, 6, 5, 3, 1, 0, 2 },
    { 7, 5, 1, 4, 3, 6, 0, 2 }, { 7, 5, 1, 4, 6, 3, 0, 2 },
    { 7, 5, 3, 4, 1, 6, 0, 2 }, { 7, 5, 3, 4, 6, 1, 0, 2 },
    { 7, 5, 4, 1, 3, 6, 0, 2 }, { 7, 5, 4, 1, 6, 3, 0, 2 },
    { 7, 5, 4, 6, 1, 3, 0, 2 }, { 7, 5, 4, 6, 3, 1, 0, 2 },
    { 7, 5, 6, 4, 1, 3, 0, 2 }, { 7, 5, 6, 4, 3, 1, 0, 2 },
    { 7, 6, 1, 4, 5, 3, 0, 2 }, { 7, 6, 3, 4, 5, 1, 0, 2 },
    { 7, 6, 4, 1, 5, 3, 0, 2 }, { 7, 6, 4, 5, 1, 3, 0, 2 },
    { 7, 6, 4, 5, 3, 1, 0, 2 }, { 7, 6, 5, 4, 1, 3, 0, 2 },
    { 7, 6, 5, 4, 3, 1, 0, 2 }
};

static inline instr_type gen_mul_opcode(uint64_t select, uint32_t* select_hi) {
    uint32_t select_lo = (uint32_t)select;
    *select_hi = (uint32_t)(select >> 32);
    return (instr_type)(select_lo % NUM_MUL_OPCODES);
}

static inline instr_type gen_arx_opcode(uint64_t select, uint32_t* select_hi) {
    uint32_t select_lo = (uint32_t)select;
    *select_hi = (uint32_t)(select >> 32);
    return arx_lookup[select_lo % NUM_ARX_OPCODES];
}

static void gen_destinations(uint32_t dst[8], const uint32_t select[7]) {
    /* Fisher–Yates shuffle */
    dst[0] = 0;
    for (int i = 1; i < 8; ++i) {
        dst[i] = i;
        uint32_t j = select[i - 1] % (i + 1);
        dst[i] = dst[j];
        dst[j] = i;
    }
}

static void gen_sources(uint32_t src[8], uint32_t dst[8], uint64_t select) {
    const uint8_t* src_perm = src_lookup[select % NUM_SRC_PERM];
    for (int i = 0; i < 8; ++i) {
        src[i] = dst[src_perm[i]];
    }
}

static uint32_t gen_imm(instr_type opcode, uint64_t select) {
    if (opcode <= INSTR_MULOR) {
        return mul_imms[select % NUM_MUL_IMMS]; /* 1, 5, 17, 65 */
    }
    if (opcode <= INSTR_ARXROR) {
        return 1 + (select % 63); /* 1-63 */
    }
    return 1 + (select % 3); /* 1-3 */
}

static void program_generate(siphash_rng* gen, hashwx_program* program) {
    /*
        The program layout is as follows:

        INSTR_RMCG (dst, imm)
        INSTR_ARX (dst, src, imm)
        INSTR_MUL (dst, src, imm)
        INSTR_ARX (dst, src, imm)
        INSTR_MUL (dst, src, imm)
        INSTR_ARX (dst, src, imm)
        INSTR_MUL (dst, src, imm)
        INSTR_BRANCH
        INSTR_ARX (dst, src, imm)
        INSTR_HALT

        Here INSTR_ARX is one of the five ARX opcodes and INSTR_MUL is one
        of the four MUL opcodes.
        The branch instruction, if taken, jumps to the start of the program.

        Eight instructions have a dst register. Destinations are selected
        as a random permutation of R0-R7.

        Seven instructions have a src register. Sources are selected from
        625 permitted permutations of the destinations.

        For INSTR_MUL, the imm value is chosen from the set  { 1, 5, 17, 65 }.
        For INSTR_ARXASR and INSTR_ARXLSR, the imm range is 1-3.
        The other instructions have an imm range of 1-63.

        In total, the generator calls hashwx_rng_next 16x.
    */

    uint32_t dst_select[7];

    /* opcodes */
    program->code[0].opcode = INSTR_RMCG;
    program->code[1].opcode = gen_arx_opcode(hashwx_rng_next(gen), &dst_select[0]);
    program->code[2].opcode = gen_mul_opcode(hashwx_rng_next(gen), &dst_select[1]);
    program->code[3].opcode = gen_arx_opcode(hashwx_rng_next(gen), &dst_select[2]);
    program->code[4].opcode = gen_mul_opcode(hashwx_rng_next(gen), &dst_select[3]);
    program->code[5].opcode = gen_arx_opcode(hashwx_rng_next(gen), &dst_select[4]);
    program->code[6].opcode = gen_mul_opcode(hashwx_rng_next(gen), &dst_select[5]);
    program->code[7].opcode = gen_arx_opcode(hashwx_rng_next(gen), &dst_select[6]);

    /* instruction destination registers */
    uint32_t dst[8];
    gen_destinations(dst, dst_select);

    /* instruction source registers */
    uint32_t src[8];
    gen_sources(src, dst, hashwx_rng_next(gen));

    /* instruction immediate values */
    for (int i = 0; i < 8; ++i) {
        program->code[i].dst = dst[i];
        program->code[i].src = src[i];
        program->code[i].imm = gen_imm(program->code[i].opcode, hashwx_rng_next(gen));
    }

    /* insert branch */
    program->code[8] = program->code[7];
    program->code[7].opcode = INSTR_BRANCH;

    /* halt */
    program->code[9].opcode = INSTR_HALT;
}

void hashwx_program_list_generate(const siphash_key* key, hashwx_program_list* program_list) {
    siphash_rng gen;
    hashwx_rng_init(&gen, key, (uint64_t)-1);
    for (int i = 0; i < HASHWX_NUM_PROGRAMS; ++i) {
        program_generate(&gen, &program_list->prog[i]);
    }
}
